<!DOCTYPE html>
<html>
<head>
    <title>Excalidraw for Box</title>
    <style>
        #app { height: 100vh; }
        .loading { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <div id="app"><div class="loading">Loading...</div></div>
    
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'https://esm.sh/react@18';
        import { createRoot } from 'https://esm.sh/react-dom@18/client';
        import { Excalidraw } from 'https://esm.sh/@excalidraw/excalidraw';
        
        // Box OAuth Configuration
        const BOX_CLIENT_ID = 'vzdokimwij921pa0xe7cqy2v88k4zz1a';
        const BOX_CLIENT_SECRET = 'M2ateaFJpY5y0gPNip3tT7PNLzUEreF9'; // Note: This is exposed in client-side code!
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        
        // Get parameters from URL (Box sends these as GET params)
        const params = new URLSearchParams(window.location.search);
        const authCode = params.get('authCode');
        const fileId = params.get('fileId');
        
        async function exchangeCodeForToken(code) {
            try {
                // Exchange auth code for access token
                // NOTE: This exposes your client secret! For production, use a serverless function
                const response = await fetch('https://api.box.com/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        client_id: BOX_CLIENT_ID,
                        client_secret: BOX_CLIENT_SECRET,
                        redirect_uri: REDIRECT_URI
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to exchange code for token');
                }
                
                const data = await response.json();
                
                // Clean up URL (remove code from URL)
                const cleanUrl = new URL(window.location);
                cleanUrl.searchParams.delete('code');
                window.history.replaceState({}, document.title, cleanUrl);
                
                return data.access_token;
            } catch (error) {
                console.error('Auth error:', error);
                alert('Authentication failed. Please try again.');
                return null;
            }
        }
        
        function App() {
            const [initialData, setInitialData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [accessToken, setAccessToken] = useState(null);
            const saveTimeoutRef = useRef(null);
            
            useEffect(() => {
                async function init() {
                    // Must have auth code to proceed
                    if (!authCode) {
                        setError('No authorization code. Please launch from Box.');
                        setLoading(false);
                        return;
                    }
                    
                    // Exchange auth code for token
                    const token = await exchangeCodeForToken(authCode);
                    if (!token) {
                        setError('Failed to authenticate with Box');
                        setLoading(false);
                        return;
                    }
                    
                    setAccessToken(token);
                    
                    // Load file from Box if we have a file ID
                    if (fileId) {
                        try {
                            const response = await fetch(`https://api.box.com/2.0/files/${fileId}/content`, {
                                headers: { 
                                    'Authorization': `Bearer ${token}` 
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error('Failed to load file');
                            }
                            
                            const data = await response.json();
                            setInitialData(data);
                        } catch (err) {
                            console.error('Error loading file:', err);
                            // File might be new or empty, that's okay
                        }
                    }
                    
                    setLoading(false);
                }
                
                init();
            }, []);
            
            const handleChange = useCallback((elements, appState, files) => {
                if (!fileId || !accessToken) return;
                
                // Clear existing timeout
                clearTimeout(saveTimeoutRef.current);
                
                // Set new timeout for saving
                saveTimeoutRef.current = setTimeout(async () => {
                    const data = {
                        type: 'excalidraw',
                        version: 2,
                        elements,
                        appState,
                        files
                    };
                    
                    try {
                        // Create form data for file upload
                        const formData = new FormData();
                        const blob = new Blob([JSON.stringify(data, null, 2)], { 
                            type: 'application/json' 
                        });
                        formData.append('file', blob, 'drawing.excalidraw');
                        
                        // Update file in Box
                        const response = await fetch(`https://upload.box.com/api/2.0/files/${fileId}/content`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                            },
                            body: formData
                        });
                        
                        if (!response.ok) {
                            console.error('Save failed:', response.status);
                        } else {
                            console.log('Saved to Box');
                        }
                    } catch (error) {
                        console.error('Error saving:', error);
                    }
                }, 2000); // Save 2 seconds after last change
            }, [fileId, accessToken]);
            
            if (loading) {
                return <div className="loading">Loading Excalidraw...</div>;
            }
            
            if (error) {
                return <div className="loading">Error: {error}</div>;
            }
            
            return (
                <Excalidraw
                    initialData={initialData}
                    onChange={handleChange}
                />
            );
        }
        
        // Create root and render
        const container = document.getElementById('app');
        const root = createRoot(container);
        root.render(<App />);
    </script>
    
    <!-- Babel Standalone for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>
