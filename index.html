<!DOCTYPE html>
<html>
<head>
    <title>Excalidraw for Box</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        #app { 
            height: 100vh; 
            width: 100vw;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .loading { 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            font-family: sans-serif;
            gap: 10px;
        }
        .loading small {
            color: #666;
            font-size: 14px;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ffcdd2;
            max-width: 600px;
            text-align: center;
        }
    </style>
    
    <!-- Excalidraw CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/@excalidraw/excalidraw@0.18.0/dist/excalidraw.production.min.css"
    />
    
    <!-- Set asset path for Excalidraw -->
    <script>
        window.EXCALIDRAW_ASSET_PATH = "https://unpkg.com/@excalidraw/excalidraw@0.18.0/dist/";
    </script>
    
    <!-- Import map for module resolution -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://unpkg.com/react@19.0.0/umd/react.production.min.js",
          "react-dom": "https://unpkg.com/react-dom@19.0.0/umd/react-dom.production.min.js",
          "react-dom/client": "https://unpkg.com/react-dom@19.0.0/client.js"
        }
      }
    </script>
</head>
<body>
    <div id="app">
        <div class="loading">
            Loading Excalidraw for Box...<br/>
            <small>Initializing...</small>
        </div>
    </div>
    
    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@19.0.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@19.0.0/umd/react-dom.production.min.js"></script>
    
    <!-- Excalidraw from CDN -->
    <script src="https://unpkg.com/@excalidraw/excalidraw@0.18.0/dist/excalidraw.production.min.js"></script>
    
    <script>
        // Box OAuth Configuration - replaced by GitHub Actions
        const BOX_CLIENT_ID = '{{BOX_CLIENT_ID}}';
        const BOX_CLIENT_SECRET = '{{BOX_CLIENT_SECRET}}';
        
        // Helper functions for file serialization
        async function serializeFiles(files) {
            const serializedFiles = {};
            
            for (const [fileId, file] of Object.entries(files || {})) {
                if (file.dataURL) {
                    serializedFiles[fileId] = {
                        ...file,
                        dataURL: file.dataURL
                    };
                } else if (file instanceof File || file instanceof Blob) {
                    const dataURL = await blobToDataURL(file);
                    serializedFiles[fileId] = {
                        id: file.id || fileId,
                        dataURL: dataURL,
                        mimeType: file.type,
                        created: file.created || Date.now()
                    };
                } else {
                    serializedFiles[fileId] = file;
                }
            }
            
            return serializedFiles;
        }
        
        function deserializeFiles(serializedFiles) {
            const files = {};
            
            for (const [fileId, fileData] of Object.entries(serializedFiles || {})) {
                if (fileData.dataURL) {
                    files[fileId] = {
                        id: fileData.id || fileId,
                        dataURL: fileData.dataURL,
                        mimeType: fileData.mimeType,
                        created: fileData.created,
                        lastRetrieved: Date.now()
                    };
                }
            }
            
            return files;
        }
        
        function blobToDataURL(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // Get parameters from URL
        const params = new URLSearchParams(window.location.search);
        const authCode = params.get('authCode');
        const fileId = params.get('fileId');
        
        async function exchangeCodeForToken(code) {
            const response = await fetch('https://api.box.com/oauth2/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: code,
                    client_id: BOX_CLIENT_ID,
                    client_secret: BOX_CLIENT_SECRET
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to exchange code for token: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Clean up URL
            const cleanUrl = new URL(window.location);
            cleanUrl.searchParams.delete('authCode');
            window.history.replaceState({}, document.title, cleanUrl);
            
            return data.access_token;
        }
        
        async function loadFileFromBox(fileId, token) {
            const response = await fetch(`https://api.box.com/2.0/files/${fileId}/content`, {
                headers: { 
                    'Authorization': `Bearer ${token}` 
                }
            });
            
            if (!response.ok) {
                if (response.status === 404) {
                    return null; // New file
                }
                throw new Error(`Failed to load file: ${response.status}`);
            }
            
            const text = await response.text();
            try {
                const data = JSON.parse(text);
                if (data.files) {
                    data.files = deserializeFiles(data.files);
                }
                return data;
            } catch (parseError) {
                return null; // Invalid JSON, treat as new file
            }
        }
        
        async function saveFileToBox(fileId, token, data) {
            const dataToSave = {
                ...data,
                files: await serializeFiles(data.files || {})
            };
            
            const formData = new FormData();
            const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { 
                type: 'application/json' 
            });
            formData.append('file', blob, 'drawing.excalidraw');
            
            const response = await fetch(`https://upload.box.com/api/2.0/files/${fileId}/content`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                },
                body: formData
            });
            
            return response.ok;
        }

        // Wait for libraries to load
        function waitForLibraries() {
            return new Promise((resolve) => {
                function check() {
                    if (window.React && window.ReactDOM && window.ExcalidrawLib) {
                        resolve();
                    } else {
                        setTimeout(check, 50);
                    }
                }
                check();
            });
        }

        const App = () => {
            const [initialData, setInitialData] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [accessToken, setAccessToken] = React.useState(null);
            const [loadingStage, setLoadingStage] = React.useState('Initializing...');
            const saveTimeoutRef = React.useRef(null);
            const maxSaveTimeoutRef = React.useRef(null);
            const lastElementsRef = React.useRef(null);
            const pendingElementsRef = React.useRef(null);
            const [excalidrawAPI, setExcalidrawAPI] = React.useState(null);
            
            React.useEffect(() => {
                async function init() {
                    try {
                        if (!authCode) {
                            throw new Error('No authorization code. Please launch from Box.');
                        }
                        
                        setLoadingStage('Authenticating with Box...');
                        const token = await exchangeCodeForToken(authCode);
                        setAccessToken(token);
                        
                        setLoadingStage('Loading file...');
                        let fileData = null;
                        if (fileId) {
                            fileData = await loadFileFromBox(fileId, token);
                            if (fileData) {
                                setInitialData(fileData);
                                lastElementsRef.current = fileData.elements || [];
                                pendingElementsRef.current = fileData.elements || [];
                            }
                        }
                        
                        setLoading(false);
                    } catch (err) {
                        setError(err.message);
                        setLoading(false);
                    }
                }
                
                init();
            }, []);
            
            const handleChange = React.useCallback((elements, appState, files) => {
                if (!fileId || !accessToken) return;
                if (appState.isLoading || appState.isResizing) return;
    
                const meaningfulChange = elements.length !== lastElementsRef.current?.length ||
                    elements.some((el, i) => el.id !== lastElementsRef.current?.[i]?.id);
    
                if (!meaningfulChange) return;

                const elementsChangedFromPending = JSON.stringify(elements) !== JSON.stringify(pendingElementsRef.current);
                if (!elementsChangedFromPending) return;
                
    	        pendingElementsRef.current = elements;
                
                if (excalidrawAPI) {
                    excalidrawAPI.setToast({ message: "Changes detected..." });
                }
                
                clearTimeout(saveTimeoutRef.current);
                
                if (!maxSaveTimeoutRef.current) {
                    maxSaveTimeoutRef.current = setTimeout(async () => {
                        await performSave(elements, appState, files);
                        maxSaveTimeoutRef.current = null;
                    }, 60000);
                }
                
                saveTimeoutRef.current = setTimeout(async () => {
                    await performSave(elements, appState, files);
                    clearTimeout(maxSaveTimeoutRef.current);
                    maxSaveTimeoutRef.current = null;
                }, 5000);
                
                async function performSave(elements, appState, files) {
                    if (excalidrawAPI) {
                        excalidrawAPI.setToast({ message: "Saving to Box..." });
                    }
                    
                    const data = {
                        type: 'excalidraw',
                        version: 2,
                        elements,
                        appState,
                        files
                    };
                    
                    const success = await saveFileToBox(fileId, accessToken, data);
                    
                    if (excalidrawAPI) {
                        excalidrawAPI.setToast({ 
                            message: success ? "Saved to Box!" : "Save failed",
                            closable: true,
                            duration: 3000
                        });
                    }
                    
                    lastElementsRef.current = elements;
                }
            }, [fileId, accessToken]);

            if (loading) {
                return React.createElement('div', { className: 'loading' }, [
                    'Loading Excalidraw for Box...',
                    React.createElement('br', { key: 'br' }),
                    React.createElement('small', { key: 'status' }, loadingStage)
                ]);
            }
            
            if (error) {
                return React.createElement('div', { className: 'loading' }, 
                    React.createElement('div', { className: 'error' }, [
                        React.createElement('strong', { key: 'title' }, 'Error'),
                        React.createElement('br', { key: 'br' }),
                        error
                    ])
                );
            }

            const excalidrawProps = {
                onChange: handleChange,
                excalidrawAPI: (api) => setExcalidrawAPI(api),
                isCollaborating: false,
                style: { height: "100vh" }
            };
            
            if (initialData) {
                excalidrawProps.initialData = initialData;
            }

            return React.createElement(
                'div',
                { style: { position: 'relative', height: "100vh" } },
                React.createElement(ExcalidrawLib.Excalidraw, excalidrawProps)
            );
        };

        // Initialize app when libraries are ready
        waitForLibraries().then(() => {
            const container = document.getElementById("app");
            const root = ReactDOM.createRoot(container);
            root.render(React.createElement(App));
        });
    </script>
</body>
</html>