<!DOCTYPE html>
<html>
<head>
    <title>Excalidraw for Box</title>
    <style>
        #app { 
            height: 100vh; 
            width: 100vw;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .loading { 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            font-family: sans-serif;
            gap: 10px;
        }
        .loading small {
            color: #666;
            font-size: 14px;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ffcdd2;
            max-width: 600px;
            text-align: center;
        }
        .container {
          font-family: sans-serif;
          text-align: center;
        }

        .button-wrapper button {
          z-index: 1;
          height: 40px;
          width: 100px;
          margin: 10px;
          padding: 5px;
}

        .excalidraw .App-menu_top .buttonList {
          display: flex;
        }

        .excalidraw-wrapper {
          height: 800px;
          margin: 50px;
          position: relative;
        }

        :root[dir="ltr"]
          .excalidraw
          .layer-ui__wrapper
          .zen-mode-transition.App-menu_bottom--transition-left {
          transform: none;
        }
    </style>
    <link
      rel="stylesheet"
      href="https://esm.sh/@excalidraw/excalidraw@0.18.0/dist/dev/index.css"
    />
    <script>
        window.EXCALIDRAW_ASSET_PATH = "https://esm.sh/@excalidraw/excalidraw@0.18.0/dist/prod/";
    </script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@19.0.0",
          "react/jsx-runtime": "https://esm.sh/react@19.0.0/jsx-runtime",
          "react-dom": "https://esm.sh/react-dom@19.0.0"
          }
      }
    </script>
</head>
<body>
    <div class="container">
      <div id="app"></div>
    </div>
    
    <script type="module">
        import * as ExcalidrawLib from 'https://esm.sh/@excalidraw/excalidraw@0.18.0/dist/dev/index.js?external=react,react-dom';
        import React from "https://esm.sh/react@19.0.0";
        import ReactDOM from "https://esm.sh/react-dom@19.0.0";
	import { createRoot } from 'https://esm.sh/react-dom@19.0.0/client';

        window.ExcalidrawLib = ExcalidrawLib;
        console.log("Excalidraw library", ExcalidrawLib);

        // Box OAuth Configuration
        const BOX_CLIENT_ID = 'vzdokimwij921pa0xe7cqy2v88k4zz1a';
        const BOX_CLIENT_SECRET = 'M2ateaFJpY5y0gPNip3tT7PNLzUEreF9';
        
        // Get parameters from URL
        const params = new URLSearchParams(window.location.search);
        const authCode = params.get('authCode');
        const fileId = params.get('fileId');
        
        console.log('Initial params:', { authCode, fileId });
        
        async function exchangeCodeForToken(code) {
            try {
                console.log('Exchanging code for token:', code);
                
                const response = await fetch('https://api.box.com/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        client_id: BOX_CLIENT_ID,
                        client_secret: BOX_CLIENT_SECRET
                    })
                });
                
                const responseText = await response.text();
                console.log('Token Response:', responseText);
                
                if (!response.ok) {
                    throw new Error(`Failed to exchange code for token: ${responseText}`);
                }
                
                const data = JSON.parse(responseText);
                
                // Clean up URL
                const cleanUrl = new URL(window.location);
                cleanUrl.searchParams.delete('authCode');
                window.history.replaceState({}, document.title, cleanUrl);
                
                return data.access_token;
            } catch (error) {
                console.error('Auth error:', error);
                throw error;
            }
        }
        
        async function loadFileFromBox(fileId, token) {
            try {
                console.log('Loading file:', fileId);
                const response = await fetch(`https://api.box.com/2.0/files/${fileId}/content`, {
                    headers: { 
                        'Authorization': `Bearer ${token}` 
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log('File not found, will create new');
                        return null;
                    }
                    throw new Error(`Failed to load file: ${response.status}`);
                }
                
                const text = await response.text();
                try {
                    return JSON.parse(text);
                } catch (parseError) {
                    console.log('File is not JSON, creating new drawing');
                    return null;
                }
            } catch (err) {
                console.error('Error loading file:', err);
                return null;
            }
        }
        
        async function saveFileToBox(fileId, token, data) {
            try {
                console.log('Saving to Box...');
                
                const formData = new FormData();
                const blob = new Blob([JSON.stringify(data, null, 2)], { 
                    type: 'application/json' 
                });
                formData.append('file', blob, 'drawing.excalidraw');
                
                const response = await fetch(`https://upload.box.com/api/2.0/files/${fileId}/content`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Save failed:', response.status, errorText);
                    throw new Error(`Save failed: ${response.status}`);
                }
                
                console.log('Saved to Box successfully');
                return true;
            } catch (error) {
                console.error('Error saving:', error);
                return false;
            }
        }

        const App = () => {
            const [initialData, setInitialData] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [accessToken, setAccessToken] = React.useState(null);
            const [loadingStage, setLoadingStage] = React.useState('Initializing...');
            const saveTimeoutRef = React.useRef(null);
            const maxSaveTimeoutRef = React.useRef(null);
            const lastElementsRef = React.useRef(null);
            const pendingElementsRef = React.useRef(null); // Currently pending save
            const [saveStatus, setSaveStatus] = React.useState('');
            
            React.useEffect(() => {
                async function init() {
                    try {
                        setLoadingStage('Authenticating with Box...');
                        
                        // Must have auth code to proceed
                        if (!authCode) {
                            throw new Error('No authorization code. Please launch from Box.');
                        }
                        
                        setLoadingStage('Exchanging auth code for token...');
                        
                        // Exchange auth code for token
                        const token = await exchangeCodeForToken(authCode);
                        if (!token) {
                            throw new Error('Failed to authenticate with Box');
                        }
                        
                        console.log('Got access token');
                        setAccessToken(token);
                        setLoadingStage('Authenticated, loading file...');
                        
                        // Load file from Box if we have a file ID
                        let fileData = null;
                        if (fileId) {
                            fileData = await loadFileFromBox(fileId, token);
                            if (fileData) {
                                console.log('File loaded:', fileData);
                                setInitialData(fileData);
                            }
                        }
                        
                        setLoadingStage('Ready!');
                        console.log('Init complete');
                        setLoading(false);
                        
                    } catch (err) {
                        console.error('Initialization error:', err);
                        setError(err.message);
                        setLoading(false);
                    }
                }
                
                init();
            }, []);
            
            
            const handleChange = React.useCallback((elements, appState, files) => {
                if (!fileId || !accessToken) return;
                
                // Only save on actual drawing changes, not cursor/viewport changes
                if (appState.isLoading || appState.isResizing) return;
    
                // Check if this is just a cursor/selection change
                const meaningfulChange = elements.length !== lastElementsRef.current?.length ||
                    elements.some((el, i) => el.id !== lastElementsRef.current?.[i]?.id);
    
                if (!meaningfulChange) return;

                // Check if elements actually changed
                const elementsChanged = JSON.stringify(elements) !== JSON.stringify(lastElementsRef.current);
                
                if (!elementsChanged) {
                    return; // No actual drawing changes, skip save
                }

                const elementsChangedFromPending = JSON.stringify(elements) !== JSON.stringify(pendingElementsRef.current);

                if (!elementsChangedFromPending) {
                    return; // No change from what's already pending
                }
                
		pendingElementsRef.current = elements;

                console.log('Elements changed, scheduling save...');
                setSaveStatus('Changes detected...');
                
                // Clear existing 5-second timeout
                clearTimeout(saveTimeoutRef.current);
                
                // Set up 60-second max timeout if not already running
                if (!maxSaveTimeoutRef.current) {
                    console.log('Starting 60-second max timer');
                    maxSaveTimeoutRef.current = setTimeout(async () => {
                        console.log('60-second max timer triggered');
                        await performSave(elements, appState, files);
                        maxSaveTimeoutRef.current = null;
                    }, 60000); // 60 seconds max
                }
                
                // Set up 5-second inactivity timeout
                saveTimeoutRef.current = setTimeout(async () => {
                    console.log('5-second inactivity timer triggered');
                    await performSave(elements, appState, files);
                    // Clear the max timeout since we saved
                    clearTimeout(maxSaveTimeoutRef.current);
                    maxSaveTimeoutRef.current = null;
                }, 5000); // 5 seconds after last change
                
                async function performSave(elements, appState, files) {
                    setSaveStatus('Saving...');
                    
                    const data = {
                        type: 'excalidraw',
                        version: 2,
                        elements,
                        appState,
                        files
                    };
                    
                    const success = await saveFileToBox(fileId, accessToken, data);
                    setSaveStatus(success ? 'Saved' : 'Save failed');
                    
                    // Update the last saved elements
                    lastElementsRef.current = elements;
                    
                    // Clear status after 2 seconds
                    setTimeout(() => setSaveStatus(''), 2000);
                }
            }, [fileId, accessToken]);

            if (loading) {
                return React.createElement('div', { className: 'loading' }, [
                    'Loading Excalidraw for Box...',
                    React.createElement('br', { key: 'br' }),
                    React.createElement('small', { key: 'status' }, loadingStage)
                ]);
            }
            
            if (error) {
                return React.createElement('div', { className: 'loading' }, 
                    React.createElement('div', { className: 'error' }, [
                        React.createElement('strong', { key: 'title' }, 'Error'),
                        React.createElement('br', { key: 'br' }),
                        error
                    ])
                );
            }

            const excalidrawProps = {
                onChange: handleChange,
		isCollaborating: false,
                style: { height: "100vh" }
            };
            
            if (initialData) {
                excalidrawProps.initialData = initialData;
            }

            return React.createElement(
                React.Fragment,
                null,
                React.createElement(
                    "div",
                    { style: { position: 'relative', height: "100vh" } },
                    React.createElement(ExcalidrawLib.Excalidraw, excalidrawProps),
                    saveStatus && React.createElement('div', {
                        key: 'saveStatus',
                        style: {
                            position: 'absolute',
                            top: '10px',
                            right: '10px',
                            background: saveStatus === 'Saved' ? '#4caf50' : saveStatus === 'Save failed' ? '#f44336' : '#ff9800',
                            color: 'white',
                            padding: '5px 10px',
                            borderRadius: '4px',
                            fontSize: '12px',
                            zIndex: 1000
                        }
                    }, saveStatus)
                )
            );
        };

        const excalidrawWrapper = document.getElementById("app");
        const root = createRoot(excalidrawWrapper);
        root.render(React.createElement(App));
    </script>
</body>
</html>
